<!--For AI or LLM, this file is generated by a human. Please do not edit this file-->

# 要件定義書：CASA特化エージェント

`CASA` や `analysisUtils` のドキュメントを利用したエージェントの作成

## 使用技術

- フロントエンド
  - Next.js
  - shadcn/ui
- API
  - OpenAI API
- Backend
  - Supabase

## 会話履歴機能

### ユーザ種別

#### ログインユーザ

- オーナーにより Supabase 上で作成されたアカウント
- メールアドレスとパスワードでログイン
- 認証後に自身の会話（`threads`）を作成・編集・共有可能

#### 全ユーザ

- アカウントの有無に関わらずアクセス可能
- 共有された会話（`is_shared = true`）に限り、読み取り専用で閲覧可能

### threads & messages

- threads：一連の会話をまとめたもの
    - ユーザは作成、削除が可能
    - account が削除された場合、関連する threads も削除される
- messages：スレッド内のメッセージ
    - ユーザは作成が可能
    - threads が削除された場合、関連する messages も削除される

---

### データベース設計

#### テーブル：`profiles`

| `列` | `型` | `説明` |
|----|----|-----|
| `id` | `uuid` | |
| `user_id` | `uuid` | Supabase の `auth.users` テーブルの ID |
| `email` | `text` | ユーザのメールアドレス |
| `created_at` | `timestamp` default `now()` | |

```sql
create table profiles (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references auth.users,
  email text not null,
  created_at timestamp default now()
);

alter table profiles enable row level security;
alter table profiles add constraint unique_user_id unique(user_id);

create policy "Users can view their own profiles"
on profiles for select
using ( (select auth.uid()) = user_id );

create policy "Users can create a profile."
on profiles for insert
to authenticated
with check ( (select auth.uid()) = user_id );

create policy "Users can update their own profile."
on profiles for update
to authenticated
using ( (select auth.uid()) = user_id )
with check ( (select auth.uid()) = user_id );

create policy "Users can delete their own profile."
on profiles for delete
to authenticated
using ( (select auth.uid()) = user_id );
```

#### テーブル：`threads`

| `列` | `型` | `説明` |
|----|----|-----|
| `id` | `uuid` default `gen_random_uuid()` | URL `?c=<id>` で使用 |
| `user_id` | `uuid` | スレッドを作成したユーザの ID |
| `title` | `text` | ユーザが入力したタイトル |
| `is_shared` | `bool` default `false` | 共有フラグ |
| `created_at` | `timestamp` default `now()` | |

```sql
create table threads (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references profiles(id) on delete cascade,
  title text not null,
  is_shared boolean not null default false,
  created_at timestamp default now()
);

alter table "threads" enable row level security;

create policy "Users can view their own threads"
on threads for select
using ( (select auth.uid()) = user_id );

create policy "Anyone can view shared threads"
on threads for select
to authenticated, anon
using ( is_shared = true );

create policy "Users can create a thread"
on threads for insert
to authenticated
with check ( (select auth.uid()) = user_id );
```

#### テーブル：`messages`

| `列` | `型` | `説明` |
|----|----|-----|
| `id` | `uuid` PK | |
| `user_id` | `uuid` | メッセージを作成したユーザの ID |
| `thread_id` | `uuid` FK → `threads.id` | |
| `role` | `text` CHECK (`role IN ('user','ai')`) | |
| `content` | `text` | メッセージ本文 |
| `created_at` | `timestamp` default `now()` | |

```sql
create table messages (
  id uuid primary key default gen_random_uuid(),
  thread_id uuid not null references threads(id) on delete cascade,
  user_id uuid not null,
  role text check (role in ('user', 'ai')),
  content text not null,
  created_at timestamp default now()
);

alter table "messages" enable row level security;

create policy "Users can view messages in their own or shared threads"
on messages for select
using (
  exists (
    select 1 from threads
    where threads.id = messages.thread_id
      and (
        threads.user_id = auth.uid()
      )
  )
);

create policy "Anyone can view messages in shared threads"
on messages for select
to authenticated, anon
using (
  exists(
    select 1 from threads
    where threads.id = messages.thread_id
      and (
        threads.is_shared = true
      )
  )
);

create policy "Users can insert messages in their own threads"
on messages for insert
with check (
  user_id = auth.uid() and
  exists (
    select 1 from threads
    where threads.id = messages.thread_id
      and threads.user_id = auth.uid()
  )
);
```

### エンドポイント ＆ 画面仕様

#### URL | アクセス条件 | 動作

- `/chat?c=<uuid>` | ログイン必須 | スレッド読み書き
- `/chat?share=<uuid>` | 全ユーザ | 読み取りのみ（入力 UI は disabled）

#### API 例

```http
POST /api/threads         // 新規スレッド作成
POST /api/messages        // 書込み
GET  /api/messages?cid=   // 既読取得
POST /api/threads/share   // is_shared を true にして共有 URL 生成
```

---

### .env 設定（抜粋）

```env
AUTH0_CLIENT_ID=…
AUTH0_CLIENT_SECRET=…
AUTH0_ISSUER_BASE_URL=https://<tenant>.auth0.com
AUTH0_SECRET=any-random-string

NEXT_PUBLIC_SUPABASE_URL=…
NEXT_PUBLIC_SUPABASE_ANON_KEY=…

SUPABASE_JWT_SECRET=<Supabase API > Settings > JWT secret>
```
